<!DOCTYPE html>
<html lang="vi">
{% load static %}
<meta name="csrf-token" content="{{ csrf_token }}">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard - Smart Parking</title>
    <link rel="stylesheet" href="{% static 'parking/css/dashboard_user.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Styles moved to dashboard_user.css -->
</head>
<body class="dashboard">
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-content">
                <h1>üß∞ Nh√¢n vi√™n Dashboard</h1>
                <div class="header-actions">
                    <p class="welcome-text">Xin ch√†o, {{ user.username }} üëã</p>
                    <a href="{% url 'logout' %}" class="btn btn-outline">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </header>

        <main class="dashboard-content">
            <!-- Main Content -->
            <div class="stream-container">
                <!-- Left Section: Camera + Controls -->
                <div class="stream-section">
                    <div class="camera-section">
                        <h2>üé• Camera Gi√°m S√°t</h2>
                        {% comment %} <img src="http://192.168.1.184:8000{% url 'video_feed' camera_id=1 %}" width="100%" class="rounded-lg shadow"> {% endcomment %}
                        <img src="{% url 'video_feed' src='raspberrypi_cam' %}"
     width="50%"
     class="rounded-lg shadow"
     id="camera-stream"
     alt="Live camera stream kh√¥ng kh·∫£ d·ª•ng">
                    </div>

                        <div class="action-buttons" style="margin-top: 20px;">
                            <button class="btn btn-primary" id="toggle-barrier">
                                <i class="fas fa-barrier-gate"></i>
                                ƒêi·ªÅu khi·ªÉn barrier
                            </button>
                            <button class="btn btn-secondary" id="refresh-data">
                                <i class="fas fa-sync"></i>
                                L√†m m·ªõi
                            </button>
                        </div>
                    </div>

                    <!-- Parking Lot Visualization -->
                    <div class="detail-card parking-visualization">
                        <div class="status-header">
                            <h3>üÖøÔ∏è S∆° ƒë·ªì b√£i xe</h3>
                            <span class="occupancy-badge" id="occupancy-rate">--</span>
                        </div>
                        
                        <div class="parking-lot-grid" id="parking-lot-grid">
                            <!-- Grid s·∫Ω ƒë∆∞·ª£c JS t·∫°o ƒë·ªông -->
                        </div>

                        <div class="parking-legend">
                            <div class="legend-item">
                                <span class="spot empty"></span>
                                <span>Tr·ªëng</span>
                            </div>
                            <div class="legend-item">
                                <span class="spot occupied"></span>
                                <span>ƒê√£ ƒë·ªó</span>
                            </div>
                            <div class="legend-item">
                                <span class="spot reserved"></span>
                                <span>ƒê√£ ƒë·∫∑t</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section: Detections -->
                <div class="detection-section">
                    <div class="latest-detection" id="latest-detection">
                        <h3>üì∏ Ph√°t hi·ªán m·ªõi nh·∫•t</h3>
                        <div class="detection-content">
                            <div>ƒêang ƒë·ª£i ph√°t hi·ªán m·ªõi...</div>
                        </div>
                    </div>

                    <div class="history-section">
                        <h3>üìã L·ªãch s·ª≠ ph√°t hi·ªán</h3>
                        <table class="detection-table">
                            <thead>
                                <tr>
                                    <th>Th·ªùi gian</th>
                                    <th>Bi·ªÉn s·ªë</th>
                                    <th>ƒê·ªô tin c·∫≠y</th>
                                    <th>·∫¢nh</th>
                                </tr>
                            </thead>
                            <tbody id="detection-history">
                                <!-- JS s·∫Ω c·∫≠p nh·∫≠t n·ªôi dung n√†y -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <!-- Detection Updates -->
  <script>
    // ‚öôÔ∏è C·∫•u h√¨nh
    const TOTAL_SPOTS = 6;
    let sensorStates = {};

    // üöó H√†m l·∫•y tr·∫°ng th√°i b√£i ƒë·ªó xe
    async function fetchParkingStatus() {
        try {
            {% comment %} const response = await fetch("{% url 'get_parking_status' %}"); {% endcomment %}
            const data = await response.json();

            Object.entries(data.status).forEach(([spot, info]) => {
                sensorStates[spot] = !info.occupied;
            });
            updateParkingStatus();
            return data;
        } catch (error) {
            console.error("‚ùå L·ªói l·∫•y tr·∫°ng th√°i b√£i xe:", error);
            return null;
        }
    }

    // üÖøÔ∏è T·∫°o grid b√£i xe
    function initializeParkingLot() {
        const grid = document.getElementById("parking-lot-grid");
        for (let i = 1; i <= TOTAL_SPOTS; i++) {
            const spot = document.createElement("div");
            spot.className = "parking-spot";
            spot.id = `spot-${i}`;
            spot.innerHTML = `<span class="spot-number">${i}</span><span class="sensor-status"></span>`;
            grid.appendChild(spot);
        }
        updateParkingStatus();
    }

    // üîÑ C·∫≠p nh·∫≠t tr·∫°ng th√°i b√£i ƒë·ªó
    function updateParkingStatus() {
        Object.entries(sensorStates).forEach(([spotId, status]) => {
            const spot = document.getElementById(`spot-${spotId}`);
            if (!spot) return;
            spot.classList.remove("empty", "occupied", "error");
            if (status === null) spot.classList.add("error");
            else if (status === true) spot.classList.add("empty");
            else spot.classList.add("occupied");
        });

        const occupied = Object.values(sensorStates).filter(s => s === false).length;
        const occupancyRate = ((occupied / TOTAL_SPOTS) * 100).toFixed(1);
        document.getElementById("occupancy-rate").textContent = `${occupancyRate}%`;
    }

    // üì∏ L·∫•y d·ªØ li·ªáu nh·∫≠n di·ªán t·ª´ Django
    async function updateDetections() {
        try {
            const response = await fetch("{% url 'latest_detections' %}");
            const data = await response.json();

            // ‚úÖ Hi·ªÉn th·ªã ph√°t hi·ªán m·ªõi nh·∫•t
            if (data.latest) {
                document.getElementById("latest-detection").innerHTML = `
                    <h3>üì∏ Ph√°t hi·ªán m·ªõi nh·∫•t</h3>
                    <div class="detection-content">
                        <div><b>${data.latest.time}</b></div>
                        <div>Bi·ªÉn s·ªë: <em>${data.latest.plate}</em></div>
                        <div>ƒê·ªô tin c·∫≠y: ${data.latest.conf}</div>
                        ${data.latest.path ? `<img src="/media/${data.latest.path}" alt="latest" style="width:100%;border-radius:8px;margin-top:6px;">` : ""}
                    </div>
                `;
            }

            // ‚úÖ B·∫£ng l·ªãch s·ª≠
            let historyHTML = "";
            const history = data.history || [];
            for (let i = history.length - 1; i >= Math.max(0, history.length - 10); i--) {
                const p = history[i];
                historyHTML += `
                    <tr>
                        <td>${p.time}</td>
                        <td>${p.plate}</td>
                        <td>${p.conf}</td>
                        <td>${p.path ? `<a href="/media/${p.path}" target="_blank">Xem</a>` : "-"}</td>
                    </tr>
                `;
            }
            document.getElementById("detection-history").innerHTML = historyHTML;
        } catch (error) {
            console.error("‚ùå L·ªói c·∫≠p nh·∫≠t nh·∫≠n di·ªán:", error);
        }
    }

    // üöÄ Kh·ªüi t·∫°o
    initializeParkingLot();
    fetchParkingStatus();
    updateDetections();

    // üîÅ C·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥ m·ªói 3 gi√¢y
    setInterval(() => {
        updateDetections();
        fetchParkingStatus();
    }, 3000);

 // üß± Barrier control
document.getElementById("toggle-barrier").addEventListener("click", async () => {
    try {
        /*
        const response = await fetch("{% url 'toggle_barrier' %}", {
            method: "POST",
            headers: { "X-CSRFToken": "{{ csrf_token }}" }
        });
        const data = await response.json();
        alert(data.message);
        */
        alert("üîß Barrier control temporarily disabled (ƒë√£ comment code).");
    } catch (error) {
        alert("L·ªói khi ƒëi·ªÅu khi·ªÉn barrier");
    }
});

</script>

</body>
</html>