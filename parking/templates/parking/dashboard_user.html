<!DOCTYPE html>
<html lang="vi">
{% load static %}
<meta name="csrf-token" content="{{ csrf_token }}">
<head>
    <meta charset="UTF-8">
    <title>User Dashboard - Smart Parking</title>
    <link rel="stylesheet" href="{% static 'parking/css/dashboard_user.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Styles moved to dashboard_user.css -->
</head>
<body class="dashboard">
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-content">
                <h1>üß∞ Nh√¢n vi√™n Dashboard</h1>
                <div class="header-actions">
                    <p class="welcome-text">Xin ch√†o, {{ user.username }} üëã</p>
                    <a href="{% url 'logout' %}" class="btn btn-outline">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </header>

        <main class="dashboard-content">
            <!-- Main Content -->
            <div class="stream-container" style="display:block;">
                <!-- Left Section: Camera + Controls -->
                <div class="stream-section" style="">
                    <div class="camera-section">
                        <h2>üé• Camera Gi√°m S√°t</h2>
                        <img src="{% url 'video_feed' src='raspberrypi_cam' %}"
                        width="50%"
                        class="rounded-lg shadow"
                        id="camera-stream"
                        alt="Live camera stream kh√¥ng kh·∫£ d·ª•ng">
                    </div>

                        <div class="action-buttons" style="margin-top: 20px;">
                            <div class="barier-control" id="control">
                                <!-- Barrier Controls -->
                                <div style="display: flex; flex-direction: row;">
                                    <div class="bar" style="border: 1px solid #ddd; padding: 10px; margin: 10px;">
                                        <h3>Barrier 1</h3>
                                        <div class="dist" id="s1" style="display:none; margin-bottom: 1rem;">Distance: - cm | State: -</div>
                                        <button onclick="cmd('B1 OPEN')" style="background-color: #6279ff; color: white; border: none; border-radius: 1rem; box-shadow: 0px 0px 8px 2px rgb(207, 207, 207); transition: all 0.3s ease; padding: 0.5rem 1rem; margin-right:8px;">Open</button>
                                        <button onclick="cmd('B1 CLOSE')" style="background-color: #6279ff; color: white; border: none; border-radius: 1rem; box-shadow: 0px 0px 8px 2px rgb(207, 207, 207); transition: all 0.3s ease; padding: 0.5rem 1rem; margin-right:8px;">Close</button>
                                        <button onclick="cmd('B1 TOGGLE')" style="background-color: #6279ff; color: white; border: none; border-radius: 1rem; box-shadow: 0px 0px 8px 2px rgb(207, 207, 207); transition: all 0.3s ease; padding: 0.5rem 1rem; margin-right:8px;">Toggle</button>
                                    </div>

                                    <div class="bar" style="border: 1px solid #ddd; padding: 10px; margin: 10px;">
                                        <h3>Barrier 2</h3>
                                        <div class="dist" id="s2" style="display:none; margin-bottom: 1rem;">Distance: - cm | State: -</div>
                                        <button onclick="cmd('B2 OPEN')" style="background-color: #6279ff; color: white; border: none; border-radius: 1rem; box-shadow: 0px 0px 8px 2px rgb(207, 207, 207); transition: all 0.3s ease; padding: 0.5rem 1rem; margin-right:8px;">Open</button>
                                        <button onclick="cmd('B2 CLOSE')" style="background-color: #6279ff; color: white; border: none; border-radius: 1rem; box-shadow: 0px 0px 8px 2px rgb(207, 207, 207); transition: all 0.3s ease; padding: 0.5rem 1rem; margin-right:8px;">Close</button>
                                        <button onclick="cmd('B2 TOGGLE')" style="background-color: #6279ff; color: white; border: none; border-radius: 1rem; box-shadow: 0px 0px 8px 2px rgb(207, 207, 207); transition: all 0.3s ease; padding: 0.5rem 1rem; margin-right:8px;">Toggle</button>
                                    </div>
                                </div>
                                <div id="info" style="display:none; margin-top: 12px;">Server status: <span id="barrier-status">-</span></div>
                            </div>

                            <script>
                                // ‚ö†Ô∏è C·∫•u h√¨nh Barrier Control
                                const SERVER_URL = "http://172.20.10.3:5000";

                                async function cmd(command) {
                                    document.getElementById('barrier-status').innerText = 'Sending ' + command;
                                    try {
                                        const r = await fetch(`${SERVER_URL}/cmd/${encodeURIComponent(command)}`);
                                        const j = await r.json();
                                        if (j.success) {
                                            document.getElementById('barrier-status').innerText = 'OK: ' + j.response;
                                            await updateStatusFromResponse(j.response);
                                        } else {
                                            document.getElementById('barrier-status').innerText = 'ERR: ' + j.error;
                                        }
                                    } catch(e) {
                                        document.getElementById('barrier-status').innerText = 'Fetch error: ' + e;
                                    }
                                }

                                async function pollBarrier() {
                                    try {
                                        const res = await fetch(`${SERVER_URL}/status`);
                                        const j = await res.json();
                                        if (j.success) {
                                            document.getElementById('s1').innerText = 'Distance: ' + j.dist1 + ' cm | State: ' + j.s1;
                                            document.getElementById('s2').innerText = 'Distance: ' + j.dist2 + ' cm | State: ' + j.s2;
                                            document.getElementById('barrier-status').innerText = 'Connected';
                                        } else {
                                            document.getElementById('barrier-status').innerText = 'Not connected';
                                        }
                                    } catch(e) {
                                        document.getElementById('barrier-status').innerText = 'Error: ' + e;
                                    }
                                }

                                async function updateStatusFromResponse(resp) {
                                    if (!resp) return;
                                    const pairs = resp.split(';');
                                    const map = {};
                                    for (let p of pairs) {
                                        const kv = p.split(':');
                                        if (kv.length == 2) map[kv[0]] = kv[1];
                                    }
                                    if (map.DIST1) document.getElementById('s1').innerText = 'Distance: ' + map.DIST1 + ' cm | State: ' + (map.S1 || '-');
                                    if (map.DIST2) document.getElementById('s2').innerText = 'Distance: ' + map.DIST2 + ' cm | State: ' + (map.S2 || '-');
                                }

                                setInterval(pollBarrier, 1000);
                                pollBarrier();
                            </script>

                            <button class="btn btn-secondary" id="refresh-data">
                                <i class="fas fa-sync"></i>
                                L√†m m·ªõi
                            </button>
                        </div>
                    </div>

                    <!-- Smart Parking Lot Widget -->
                    <div class="detail-card parking-visualization" style="width:100%;">
                        <div style="font-family: Arial; text-align:center; width:100%;">
                            <h2>üÖøÔ∏è B√£i ƒë·ªó xe th√¥ng minh</h2>
                            <div id="slots" style="display:grid; grid-template-columns:repeat(3,150px); grid-template-rows:repeat(2,150px); gap:20px; justify-content:center;"></div>
                            <div id="status" style="margin-top:10px; font-size:16px;">ƒêang k·∫øt n·ªëi...</div>
                        </div>
                    </div>
                </div>

                <!-- Right Section: Detections -->
                <div class="detection-section">
                    <div class="latest-detection" id="latest-detection">
                        <h3>üì∏ Ph√°t hi·ªán m·ªõi nh·∫•t</h3>
                        <div class="detection-content">
                            <div>ƒêang ƒë·ª£i ph√°t hi·ªán m·ªõi...</div>
                        </div>
                    </div>

                    <div class="history-section">
                        <h3>üìã L·ªãch s·ª≠ ph√°t hi·ªán</h3>
                        <table class="detection-table">
                            <thead>
                                <tr>
                                    <th>Th·ªùi gian</th>
                                    <th>Bi·ªÉn s·ªë</th>
                                    <th>ƒê·ªô tin c·∫≠y</th>
                                    <th>S·ª± ki·ªán</th>
                                </tr>
                            </thead>
                            <tbody id="detection-history">
                                <!-- JS s·∫Ω c·∫≠p nh·∫≠t n·ªôi dung n√†y -->
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 15px;">
                            <button id="load-more-btn" class="btn btn-secondary" style="display:none;">
                                üîÑ Xem th√™m
                            </button>
                            <div id="load-more-status" style="margin-top: 10px; color: #666; font-size: 14px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <!-- Detection Updates -->
<script>
    // üÖøÔ∏è Smart Parking Lot - Polling t·ª´ server c·∫£m bi·∫øn
    const PARKING_SERVER_URL = "http://172.20.10.2:5000"; // ƒë·ªïi th√†nh IP m√°y ch·ªß c·ªßa b·∫°n

    async function pollParking() {
        try {
            const res = await fetch(PARKING_SERVER_URL + '/status');
            const data = await res.json();
            const container = document.getElementById('slots');
            if (!data.success) {
                document.getElementById('status').innerText = '‚ùå M·∫•t k·∫øt n·ªëi ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu';
                return;
            }
            container.innerHTML = '';
            data.slots.forEach(s => {
                const div = document.createElement('div');
                div.className = 'slot';
                if (s.state === 'OCCUPIED') div.classList.add('occupied');
                div.innerHTML = `<b>√î ${s.id}</b><br>${s.state==='OCCUPIED'?'üöó ƒê√£ chi·∫øm':'üÖøÔ∏è Tr·ªëng'}<br><small>${s.dist} cm</small>`;
                container.appendChild(div);
            });
            document.getElementById('status').innerText = '‚úÖ ƒê√£ c·∫≠p nh·∫≠t l√∫c ' + new Date().toLocaleTimeString();
        } catch (e) {
            document.getElementById('status').innerText = '‚ö†Ô∏è L·ªói khi l·∫•y d·ªØ li·ªáu: ' + e.message;
        }
    }

    // üì∏ L·∫•y d·ªØ li·ªáu nh·∫≠n di·ªán t·ª´ Django
    let currentPage = 1;
    const itemsPerPage = 10;
    let allHistory = [];

    async function updateDetections(reset = false) {
        try {
            const response = await fetch("{% url 'latest_detections' %}");
            const data = await response.json();

            // ‚úÖ Hi·ªÉn th·ªã ph√°t hi·ªán m·ªõi nh·∫•t
            if (data.latest) {
                document.getElementById("latest-detection").innerHTML = `
                    <h3>üì∏ Ph√°t hi·ªán m·ªõi nh·∫•t</h3>
                    <div class="detection-content">
                        <div><b>${data.latest.time}</b></div>
                        <div>Bi·ªÉn s·ªë: <em>${data.latest.plate}</em></div>
                        <div>ƒê·ªô tin c·∫≠y: ${data.latest.conf}</div>
                        <div>S·ª± ki·ªán: <span style="color: ${data.latest.event === 'ENTRY' ? '#4CAF50' : '#f44336'}; font-weight: bold;">${data.latest.event === 'ENTRY' ? 'üöó V√ÄO' : 'üö¶ RA'}</span></div>
                        ${data.latest.path ? `<img src="/media/${data.latest.path}" alt="latest" style="width:100%;border-radius:8px;margin-top:6px;">` : ""}
                    </div>
                `;
            }

            // ‚úÖ L∆∞u to√†n b·ªô l·ªãch s·ª≠
            if (reset || allHistory.length === 0) {
                allHistory = data.history || [];
                currentPage = 1;
            }

            // Hi·ªÉn th·ªã theo trang
            renderHistory();
        } catch (error) {
            console.error("‚ùå L·ªói c·∫≠p nh·∫≠t nh·∫≠n di·ªán:", error);
        }
    }

    function renderHistory() {
        const totalItems = allHistory.length;
        const showItems = currentPage * itemsPerPage;
        const itemsToShow = Math.min(showItems, totalItems);

        // Hi·ªÉn th·ªã t·ª´ m·ªõi nh·∫•t (reverse order)
        let historyHTML = "";
        for (let i = 0; i < itemsToShow; i++) {
            const p = allHistory[i];
            const eventColor = p.event === 'ENTRY' ? '#4CAF50' : '#f44336';
            const eventIcon = p.event === 'ENTRY' ? 'üöó' : 'üö¶';
            historyHTML += `
                <tr>
                    <td>${p.time}</td>
                    <td><b>${p.plate}</b></td>
                    <td>${p.conf}</td>
                    <td style="color: ${eventColor};"><b>${eventIcon} ${p.event}</b></td>
                </tr>
            `;
        }

        if (historyHTML === "") {
            historyHTML = '<tr><td colspan="4" style="text-align:center; color:#999;">üí≠ Ch∆∞a c√≥ l·ªãch s·ª≠ ph√°t hi·ªán</td></tr>';
        }

        document.getElementById("detection-history").innerHTML = historyHTML;

        // Hi·ªÉn/·∫©n n√∫t "Xem th√™m"
        const loadMoreBtn = document.getElementById('load-more-btn');
        const loadMoreStatus = document.getElementById('load-more-status');

        if (itemsToShow < totalItems) {
            loadMoreBtn.style.display = 'inline-block';
            loadMoreStatus.innerText = `Hi·ªÉn th·ªã ${itemsToShow}/${totalItems} b·∫£n ghi`;
        } else {
            loadMoreBtn.style.display = 'none';
            if (totalItems > 0) {
                loadMoreStatus.innerText = `‚úÖ ƒê√£ hi·ªÉn th·ªã t·∫•t c·∫£ ${totalItems} b·∫£n ghi`;
            } else {
                loadMoreStatus.innerText = '';
            }
        }
    }

    // X·ª≠ l√Ω n√∫t "Xem th√™m"
    document.getElementById('load-more-btn').addEventListener('click', () => {
        currentPage++;
        renderHistory();
    });

    // üì∏ L·∫•y d·ªØ li·ªáu nh·∫≠n di·ªán t·ª´ Django

    // üöÄ Kh·ªüi t·∫°o
    updateDetections(true); // Reset ƒë·ªÉ load d·ªØ li·ªáu ban ƒë·∫ßu
    pollParking(); // Kh·ªüi t·∫°o polling b√£i xe

    // üîÅ C·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥
    setInterval(() => {
        updateDetections(true); // Reset=true ƒë·ªÉ t·ª± ƒë·ªông c·∫≠p nh·∫≠t l·ªãch s·ª≠ m·ªõi nh·∫•t m·ªói 3 gi√¢y
    }, 3000);
    
    setInterval(pollParking, 1000); // C·∫≠p nh·∫≠t tr·∫°ng th√°i b√£i xe m·ªói 1 gi√¢y

</script>

</body>
</html>