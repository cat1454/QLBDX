<!DOCTYPE html>
<html lang="vi">
{% load static %}
<head>
    <meta charset="UTF-8">
    <title>User Dashboard - Smart Parking</title>
    <link rel="stylesheet" href="{% static 'parking/css/dashboard_user.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Styles moved to dashboard_user.css -->
</head>
<body class="dashboard">
    <div class="dashboard-container">
        <header class="dashboard-header">
            <div class="header-content">
                <h1>üß∞ Nh√¢n vi√™n Dashboard</h1>
                <div class="header-actions">
                    <p class="welcome-text">Xin ch√†o, {{ user.username }} üëã</p>
                    <a href="{% url 'logout' %}" class="btn btn-outline">ƒêƒÉng xu·∫•t</a>
                </div>
            </div>
        </header>

        <main class="dashboard-content">
            <!-- Main Content -->
            <div class="stream-container">
                <!-- Left Section: Camera + Controls -->
                <div class="stream-section">
                    <div class="camera-section">
                        <h2>üé• Camera Gi√°m S√°t</h2>
                        <img src="http://192.168.1.184:8000{% url 'video_feed' camera_id=1 %}" width="100%" class="rounded-lg shadow">
                        
                        <div class="action-buttons" style="margin-top: 20px;">
                            <button class="btn btn-primary" id="toggle-barrier">
                                <i class="fas fa-barrier-gate"></i>
                                ƒêi·ªÅu khi·ªÉn barrier
                            </button>
                            <button class="btn btn-secondary" id="refresh-data">
                                <i class="fas fa-sync"></i>
                                L√†m m·ªõi
                            </button>
                        </div>
                    </div>

                    <!-- Parking Lot Visualization -->
                    <div class="detail-card parking-visualization">
                        <div class="status-header">
                            <h3>üÖøÔ∏è S∆° ƒë·ªì b√£i xe</h3>
                            <span class="occupancy-badge" id="occupancy-rate">--</span>
                        </div>
                        
                        <div class="parking-lot-grid" id="parking-lot-grid">
                            <!-- Grid s·∫Ω ƒë∆∞·ª£c JS t·∫°o ƒë·ªông -->
                        </div>

                        <div class="parking-legend">
                            <div class="legend-item">
                                <span class="spot empty"></span>
                                <span>Tr·ªëng</span>
                            </div>
                            <div class="legend-item">
                                <span class="spot occupied"></span>
                                <span>ƒê√£ ƒë·ªó</span>
                            </div>
                            <div class="legend-item">
                                <span class="spot reserved"></span>
                                <span>ƒê√£ ƒë·∫∑t</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Section: Detections -->
                <div class="detection-section">
                    <div class="latest-detection" id="latest-detection">
                        <h3>üì∏ Ph√°t hi·ªán m·ªõi nh·∫•t</h3>
                        <div class="detection-content">
                            <div>ƒêang ƒë·ª£i ph√°t hi·ªán m·ªõi...</div>
                        </div>
                    </div>

                    <div class="history-section">
                        <h3>üìã L·ªãch s·ª≠ ph√°t hi·ªán</h3>
                        <table class="detection-table">
                            <thead>
                                <tr>
                                    <th>Th·ªùi gian</th>
                                    <th>Bi·ªÉn s·ªë</th>
                                    <th>ƒê·ªô tin c·∫≠y</th>
                                    <th>·∫¢nh</th>
                                </tr>
                            </thead>
                            <tbody id="detection-history">
                                <!-- JS s·∫Ω c·∫≠p nh·∫≠t n·ªôi dung n√†y -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/your-code.js" crossorigin="anonymous"></script>
    
    <!-- Detection Updates -->
    <script>
        // C·∫•u h√¨nh
        const TOTAL_SPOTS = 6; // 6 ch·ªó ƒë·ªó xe
        const SPOTS_PER_ROW = 3; // 3 √¥ m·ªói h√†ng

        // Kh·ªüi t·∫°o tr·∫°ng th√°i c·∫£m bi·∫øn r·ªóng
        let sensorStates = {};
        
        // H√†m l·∫•y tr·∫°ng th√°i b√£i ƒë·ªó xe t·ª´ server
        async function fetchParkingStatus() {
            try {
                {% comment %} const response = await fetch('{% url "get_parking_status" %}'); {% endcomment %}
                const data = await response.json();
                
                // C·∫≠p nh·∫≠t tr·∫°ng th√°i c·∫£m bi·∫øn
                Object.entries(data.status).forEach(([spot, info]) => {
                    sensorStates[spot] = !info.occupied;
                });
                
                // C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt
                Object.entries(data.status).forEach(([spot, info]) => {
                    const spotElement = document.getElementById(`spot-${spot}`);
                    if (spotElement) {
                        if (info.occupied) {
                            spotElement.title = `V·ªã tr√≠ ${spot}\nBi·ªÉn s·ªë: ${info.plate}\nV√†o l√∫c: ${info.entry_time}`;
                        } else {
                            spotElement.title = `V·ªã tr√≠ ${spot}\nTr·ªëng`;
                        }
                    }
                });
                
                return data;
            } catch (error) {
                console.error('Error fetching parking status:', error);
                return null;
            }
        };

        // Kh·ªüi t·∫°o grid b√£i ƒë·ªó xe
        function initializeParkingLot() {
            const grid = document.getElementById('parking-lot-grid');
            for (let i = 1; i <= TOTAL_SPOTS; i++) {
                const spot = document.createElement('div');
                spot.className = 'parking-spot';
                spot.id = `spot-${i}`;
                
                // T·∫°o c·∫•u tr√∫c n·ªôi dung cho m·ªói √¥
                spot.innerHTML = `
                    <span class="spot-number">${i}</span>
                    <span class="sensor-status"></span>
                `;
                
                spot.title = `V·ªã tr√≠ ${i}`;
                grid.appendChild(spot);
            }
            updateParkingStatus(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i ban ƒë·∫ßu
        }

        // C·∫≠p nh·∫≠t tr·∫°ng th√°i d·ª±a tr√™n d·ªØ li·ªáu c·∫£m bi·∫øn
        function updateParkingStatus() {
            // Trong th·ª±c t·∫ø, s·∫Ω g·ªçi API ƒë·ªÉ l·∫•y tr·∫°ng th√°i c·∫£m bi·∫øn
            // V√≠ d·ª•: fetch('/api/sensor-status').then(r => r.json()).then(data => { sensorStates = data; })
            
            Object.entries(sensorStates).forEach(([spotId, status]) => {
                const spot = document.getElementById(`spot-${spotId}`);
                if (!spot) return;

                // X√≥a c√°c class c≈©
                spot.classList.remove('empty', 'occupied', 'error');

                // C·∫≠p nh·∫≠t tr·∫°ng th√°i m·ªõi
                if (status === null) {
                    spot.classList.add('error');
                } else if (status === true) {
                    spot.classList.add('empty');
                } else {
                    spot.classList.add('occupied');
                }
            });

            // C·∫≠p nh·∫≠t t·ª∑ l·ªá s·ª≠ d·ª•ng
            const occupied = Object.values(sensorStates).filter(s => s === false).length;
            const occupancyRate = ((occupied / TOTAL_SPOTS) * 100).toFixed(1);
            document.getElementById('occupancy-rate').textContent = `${occupancyRate}%`;
        }

        function updateDetections() {
            // G·ªçi API ƒë·ªÉ l·∫•y d·ªØ li·ªáu ph√°t hi·ªán v√† tr·∫°ng th√°i b√£i ƒë·ªó
            Promise.all([
                fetch('{% url "latest_detections" %}'),
                {% comment %} fetch('{% url "get_parking_status" %}') {% endcomment %}
            ])
            .then(responses => Promise.all(responses.map(r => r.json())))
            .then(([detectionData, parkingData]) => {
                // C·∫≠p nh·∫≠t ph√°t hi·ªán m·ªõi nh·∫•t
                if (detectionData.latest) {
                    document.getElementById('latest-detection').innerHTML = `
                        <h3>üì∏ Ph√°t hi·ªán m·ªõi nh·∫•t</h3>
                        <div class="detection-content">
                            <div><b>${detectionData.latest.time}</b></div>
                            <div>Bi·ªÉn s·ªë: <em>${detectionData.latest.plate}</em></div>
                            <div>ƒê·ªô tin c·∫≠y: ${detectionData.latest.conf}</div>
                            ${detectionData.latest.path ? `<img src="/${detectionData.latest.path}?t=${Date.now()}" alt="latest">` : ''}
                        </div>
                    `;
                }

                    // C·∫≠p nh·∫≠t b·∫£ng l·ªãch s·ª≠
                    let historyHTML = '';
                    for (let i = data.history.length - 1; i >= Math.max(0, data.history.length - 10); i--) {
                        const p = data.history[i];
                        historyHTML += `
                            <tr>
                                <td>${p.time.split(' ')[1]}</td>
                                <td>${p.plate}</td>
                                <td>${p.conf}</td>
                                <td>${p.path ? `<a href="/${p.path}" target="_blank">Xem</a>` : '-'}</td>
                            </tr>
                        `;
                    }
                    document.getElementById('detection-history').innerHTML = historyHTML;

                    // ∆Ø·ªõc t√≠nh s·ªë xe hi·ªán t·∫°i (30% s·ªë xe v√†o v·∫´n trong b√£i)
                    const currentVehicles = Math.round(data.history.length * 0.3);
                    const occupancyRate = (currentVehicles / TOTAL_SPOTS * 100).toFixed(1);
                    
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã b√£i ƒë·ªó
                    document.getElementById('occupancy-rate').textContent = `${occupancyRate}%`;
                    updateParkingStatus(currentVehicles);
                });
        }

        // Kh·ªüi t·∫°o b√£i ƒë·ªó xe
        initializeParkingLot();

        // C·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥
        function startUpdates() {
            // C·∫≠p nh·∫≠t ph√°t hi·ªán v√† tr·∫°ng th√°i b√£i ƒë·ªó
            setInterval(async () => {
                await updateDetections();
                await fetchParkingStatus();
                updateParkingStatus();
            }, 3000);
            
            // C·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
            updateDetections();
            fetchParkingStatus().then(() => updateParkingStatus());
        }

        // B·∫Øt ƒë·∫ßu c·∫≠p nh·∫≠t
        startUpdates();

        // X·ª≠ l√Ω n√∫t barrier
        document.getElementById('toggle-barrier').addEventListener('click', async function() {
            try {
                {% comment %} const response = await fetch('{% url "toggle_barrier" %}', { {% endcomment %}
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                });
                const data = await response.json();
                alert(data.message);
            } catch (error) {
                console.error('Error toggling barrier:', error);
                alert('L·ªói khi ƒëi·ªÅu khi·ªÉn barrier');
            }
        });

        // N√∫t l√†m m·ªõi
        document.getElementById('refresh-data').addEventListener('click', updateDetections);

        // Gi·∫£ l·∫≠p c·∫≠p nh·∫≠t t·ª´ c·∫£m bi·∫øn
        function simulateSensorUpdate() {
            // Trong th·ª±c t·∫ø, ƒë√¢y s·∫Ω l√† WebSocket ho·∫∑c polling ƒë·ªÉ nh·∫≠n d·ªØ li·ªáu c·∫£m bi·∫øn
            setInterval(() => {
                // Gi·∫£ l·∫≠p thay ƒë·ªïi ng·∫´u nhi√™n cho demo
                const randomSpot = Math.floor(Math.random() * TOTAL_SPOTS) + 1;
                const randomStatus = Math.random() > 0.8 ? null : Math.random() > 0.5;
                sensorStates[randomSpot] = randomStatus;
                updateParkingStatus();
            }, 5000); // C·∫≠p nh·∫≠t m·ªói 5 gi√¢y
        }

        // X·ª≠ l√Ω click v√†o √¥ ƒë·ªó xe
        document.querySelector('.parking-lot-grid').addEventListener('click', function(e) {
            const spot = e.target.closest('.parking-spot');
            if (!spot) return;

            const spotId = spot.id.split('-')[1];
            const status = sensorStates[spotId];
            const statusText = status === null ? 'L·ªói c·∫£m bi·∫øn' :
                             status === true ? 'ƒêang tr·ªëng' : 'C√≥ xe ƒëang ƒë·ªó';
            
            alert(`V·ªã tr√≠ ${spotId}:\n${statusText}\nC·∫≠p nh·∫≠t l·∫ßn cu·ªëi: ${new Date().toLocaleTimeString()}`);
        });

        // B·∫Øt ƒë·∫ßu gi·∫£ l·∫≠p c·∫≠p nh·∫≠t c·∫£m bi·∫øn (ch·ªâ ƒë·ªÉ demo)
        simulateSensorUpdate();

        // N√∫t l√†m m·ªõi
        document.getElementById('refresh-data').addEventListener('click', function() {
            updateParkingStatus();
            updateDetections();
        });
    </script>
</body>
</html>